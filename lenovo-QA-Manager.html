<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lenovo QA Manager</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        lenovo: {
                            red: '#E2231A',
                            dark: '#D11006'
                        },
                        slate: {
                            850: '#1e293b', 
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <!-- Dexie.js (IndexedDB Wrapper) -->
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .light .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #E2231A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        
        Chart.register(ChartDataLabels);

        // --- CONSTANTS & CONFIG ---

        // ⚠️ ADMIN SETUP: Paste your Gemini API Key inside the quotes below to auto-load it for all users.
        const DEFAULT_GEMINI_API_KEY = "AIzaSyBfe4UioV5Is_11MTXC_XCJ95NdNYlx55o"; 
        const DEFAULT_GEMINI_MODEL = "gemini-2.5-flash"; // Updated Default model

        const CORE_AGENTS = [
            "Amir Daniel", "Amr Ibrahim", "Rawan Essam", "Noura Aly", "Youssef Abdelshafy"
        ];

        // --- LAYER 4: AI PROMPT ARCHITECTURE ---
        const AI_PROMPTS = {
            system: `You are a Principal QA Analyst for Lenovo Support. Your goal is to evaluate customer service chat logs against a specific scorecard.
You must be objective, identifying both specific failures and good behaviors.
You prioritize:
1. Active Listening (Did the agent actually answer the customer's specific question?)
2. Process Adherence (Did they verify SN, ask for permission, etc?)
3. Solution Accuracy (Did they provide the correct link/steps?)
4. Tone (Was it professional yet empathetic?)

You will be provided with:
1. A Scorecard Definition (Criteria)
2. A Chat Transcript (annotated with phases)
3. Computed Risk Flags

Output Format: JSON only. No markdown.
Structure:
{
  "summary": "2-sentence summary of the interaction.",
  "sentiment_trajectory": "Positive -> Neutral -> Negative",
  "criteria_scores": {
    "greet": "Yes/No/NA",
    "discovery": "Yes/No/NA",
    // ... maps to scorecard IDs
  },
  "reasoning": {
    "greet": "Agent said 'Hello'",
    "discovery": "Agent asked about the OS version and error message.",
    // ... brief evidence for each score
  },
  "critical_fail": "None" or "CX Critical" or "Compliance Critical",
  "critical_reason": "Explanation if critical fail",
  "coaching_tip": "Specific actionable feedback for the agent."
}`,
            userTemplate: (chat, scorecard) => `
CHAT CONTEXT:
Agent: ${chat.agent}
Date: ${chat.dateStr}
Risk Flags: ${JSON.stringify(chat.flags)}
Flow Issues: ${JSON.stringify(chat.flowFlags)}

SCORECARD CRITERIA IDs (Use these keys for criteria_scores):
${JSON.stringify(Object.values(scorecard).flat().map(i => ({id: i.id, text: i.text})))}

TRANSCRIPT:
${chat.messages.map(m => `[${m.time}] [${m.phase}] ${m.sender}: ${m.text}`).join('\n')}
`
        };

        // --- WORKER CODE (Embedded - Layer 2 Implemented + Tuned) ---
        const WORKER_CODE = `
        importScripts('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js');

        const CORE_AGENTS = [
            "Amir Daniel", "Amr Ibrahim", "Rawan Essam", "Noura Aly", "Youssef Abdelshafy"
        ];
        
        const NEGATIVE_KEYWORDS = ['upset', 'angry', 'complaint', 'manager', 'fail', 'broken', 'slow', 'bad', 'wrong', 'ridiculous', 'waiting', 'waste', 'cancel', 'terrible', 'useless'];

        // --- LAYER 1: DETERMINISTIC LOGIC (TUNED) ---
        const INTENT_PATTERNS = {
            greeting: ['hello', 'hi', 'morning', 'afternoon', 'evening', 'welcome', 'assist'],
            closing: ['thank', 'bye', 'goodbye', 'help you with', 'anything else', 'wonderful day'],
            question: ['?', 'what', 'how', 'when', 'why', 'where', 'may i', 'can i', 'could you'],
            problem: ['not working', 'broken', 'issue', 'problem', 'fail', 'error', 'damage', 'slow', 'blue screen', 'boot', 'charge'],
            instruction: ['click', 'link', 'visit', 'go to', 'steps', 'setting', 'select', 'press', 'type', 'enter'],
            warranty: ['warranty', 'repair', 'onsite', 'depot', 'coverage', 'entitlement'],
            empathy: ['sorry', 'apologize', 'understand', 'regret', 'frustrating'],
            confirmation: ['yes', 'correct', 'ok', 'okay', 'sure', 'right', 'will do'],
            data: ['serial', 'sn', 'email', 'phone', 'address', 'model', 'number']
        };

        const detectIntent = (text) => {
            const lower = text.toLowerCase();
            for (const [intent, keywords] of Object.entries(INTENT_PATTERNS)) {
                if (intent === 'question' && lower.includes('?')) return 'Question';
                if (keywords.some(k => lower.includes(k))) return intent.charAt(0).toUpperCase() + intent.slice(1);
            }
            return 'Statement';
        };

        const segmentPhases = (messages) => {
            let phase = 'Opening';
            const segmented = [];
            
            const closingIndices = new Set();
            for (let i = messages.length - 1; i >= 0; i--) {
                const intent = detectIntent(messages[i].text);
                if (intent === 'Closing' || (i > messages.length - 4)) {
                    closingIndices.add(i);
                } else {
                    break; 
                }
            }

            for (let i = 0; i < messages.length; i++) {
                const msg = messages[i];
                const intent = detectIntent(msg.text);
                
                if (closingIndices.has(i)) {
                    phase = 'Closing';
                } else if (phase === 'Opening') {
                    if (intent === 'Problem' || intent === 'Data' || (intent === 'Question' && i > 1) || i > 4) {
                        phase = 'Discovery';
                    }
                } else if (phase === 'Discovery') {
                    if (msg.type === 'agent' && (intent === 'Warranty' || (intent === 'Instruction' && msg.text.length > 100))) {
                        phase = 'Resolution';
                    }
                }
                segmented.push({ ...msg, intent, phase });
            }
            return segmented;
        };

        // --- LAYER 2: FLOW & BEHAVIOR ANALYSIS (TUNED) ---
        const analyzeFlow = (messages) => {
            let score = 100;
            const flags = {
                skippedDiscovery: false,
                poorProbing: false,
                rushedClosing: false,
                escalation: false
            };

            const phases = new Set(messages.map(m => m.phase));
            const agentDiscoveryMsgs = messages.filter(m => m.phase === 'Discovery' && m.type === 'agent');
            const discoveryQuestions = agentDiscoveryMsgs.filter(m => m.intent === 'Question' || m.text.includes('?'));

            if (messages.length > 10 && (!phases.has('Discovery') || agentDiscoveryMsgs.length < 1)) {
                score -= 20;
                flags.skippedDiscovery = true;
            } else if (messages.length > 10 && discoveryQuestions.length < 2) {
                score -= 10;
                flags.poorProbing = true;
            }

            if (!phases.has('Closing')) {
                score -= 10;
                flags.rushedClosing = true;
            }

            const escalationKeywords = ['manager', 'supervisor', 'escalate', 'complaint', 'lawyer', 'sue'];
            const customerMsgs = messages.filter(m => m.type === 'customer');
            if (customerMsgs.some(m => escalationKeywords.some(k => m.text.toLowerCase().includes(k)))) {
                score -= 20;
                flags.escalation = true;
            }

            return { score: Math.max(0, score), flags };
        };

        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            const cleanStr = dateStr.trim();
            const parts = cleanStr.split(/[\\/\\-\\s:TZ]/).filter(p => p !== ""); 
            if (parts.length >= 3) {
                let day, month, year, hours=0, minutes=0, seconds=0;
                if (parts[2].length === 4) { day = parseInt(parts[0], 10); month = parseInt(parts[1], 10) - 1; year = parseInt(parts[2], 10); if (parts.length >= 4) hours = parseInt(parts[3], 10); if (parts.length >= 5) minutes = parseInt(parts[4], 10); if (parts.length >= 6) seconds = parseInt(parts[5], 10); return new Date(year, month, day, hours, minutes, seconds); }
                if (parts[0].length === 4) { year = parseInt(parts[0], 10); month = parseInt(parts[1], 10) - 1; day = parseInt(parts[2], 10); if (parts.length >= 4) hours = parseInt(parts[3], 10); if (parts.length >= 5) minutes = parseInt(parts[4], 10); if (parts.length >= 6) seconds = parseInt(parts[5], 10); return new Date(year, month, day, hours, minutes, seconds); }
            }
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? new Date(0) : d;
        };

        self.onmessage = async (e) => {
            const { type, payload } = e.data;
            if (type === 'PROCESS_CHATS') {
                try {
                    const files = payload;
                    let combinedRows = [];
                    for (let i = 0; i < files.length; i++) {
                        self.postMessage({ type: 'PROGRESS', value: Math.round((i / files.length) * 20), message: \`Reading file \${i + 1}/\${files.length}...\` });
                        const text = await files[i].text(); 
                        const result = Papa.parse(text, { header: true, skipEmptyLines: true });
                        combinedRows = combinedRows.concat(result.data);
                    }
                    self.postMessage({ type: 'PROGRESS', value: 25, message: \`Grouping \${combinedRows.length} rows...\` });
                    const groups = {};
                    combinedRows.forEach(row => {
                        const id = row.chatid || row['Chat ID'] || row.ConversationID;
                        if (!id) return;
                        if (!groups[id]) groups[id] = [];
                        groups[id].push(row);
                    });
                    const groupEntries = Object.entries(groups);
                    const totalChats = groupEntries.length;
                    const processedChats = [];

                    for (let i = 0; i < totalChats; i++) {
                        const [id, messages] = groupEntries[i];
                        messages.sort((a, b) => new Date(a.date) - new Date(b.date));
                        let agentName = "Unknown";
                        let date = parseDate(messages[0]?.date);
                        const formattedMsgs = [];
                        const systemMsg = messages.find(m => (m.from === 'System' || m.text.includes('System:')) && (m.text.includes('Proactive chat started by') || m.text.includes('Ended by') || m.text.includes('Assigned to')));
                        if (systemMsg) {
                            const text = systemMsg.text;
                            const foundCore = CORE_AGENTS.find(a => text.includes(a));
                            if (foundCore) agentName = foundCore;
                            else { const match = text.match(/by\\s+([A-Za-z\\s]+)/); if (match && match[1]) agentName = match[1].trim(); }
                        }
                        if (agentName === "Unknown") {
                            const coreSender = messages.find(m => CORE_AGENTS.includes(m.from));
                            if (coreSender) agentName = coreSender.from;
                        }
                        messages.forEach(m => {
                            formattedMsgs.push({
                                sender: m.from,
                                text: m.text,
                                time: m.date,
                                type: CORE_AGENTS.includes(m.from) || m.from === agentName ? 'agent' : ['System', 'Bot', 'Lenovo Bot'].includes(m.from) ? 'system' : 'customer'
                            });
                        });

                        const enrichedMsgs = segmentPhases(formattedMsgs);
                        const flowAnalysis = analyzeFlow(enrichedMsgs);

                        const msgs = enrichedMsgs; 
                        let sentimentDrop = false;
                        let longDuration = false;
                        let silence = false;
                        let expired = false;
                        if (msgs.length > 1) {
                            const startTime = parseDate(msgs[0].time).getTime();
                            const endTime = parseDate(msgs[msgs.length - 1].time).getTime();
                            const durationMinutes = (endTime - startTime) / 1000 / 60;
                            if (durationMinutes > 45) longDuration = true;
                            for (let j = 0; j < msgs.length - 1; j++) {
                                const t1 = parseDate(msgs[j].time).getTime();
                                const t2 = parseDate(msgs[j+1].time).getTime();
                                const gapMin = (t2 - t1) / 1000 / 60;
                                if (gapMin > 30) expired = true;
                                if (msgs[j].type === 'customer' && msgs[j+1].type === 'agent') { if (gapMin > 5) silence = true; }
                            }
                            const cutOff = Math.floor(msgs.length * 0.8);
                            const lastPart = msgs.slice(cutOff);
                            const customerLastPart = lastPart.filter(m => m.type === 'customer');
                            sentimentDrop = customerLastPart.some(m => NEGATIVE_KEYWORDS.some(k => m.text.toLowerCase().includes(k)));
                        }
                        let riskScore = 0;
                        if (sentimentDrop) riskScore += 30;
                        if (expired) riskScore += 20;
                        if (silence) riskScore += 10;
                        if (longDuration) riskScore += 5;

                        processedChats.push({
                            id,
                            agent: agentName,
                            date: date, 
                            messages: enrichedMsgs, 
                            dateStr: messages[0]?.date,
                            riskScore,
                            flags: { sentimentDrop, longDuration, silence, expired },
                            flowScore: flowAnalysis.score,
                            flowFlags: flowAnalysis.flags
                        });

                        if (i % 200 === 0) { self.postMessage({ type: 'PROGRESS', value: 25 + Math.round((i / totalChats) * 75), message: 'Processing Flow & Risks...' }); }
                    }
                    self.postMessage({ type: 'COMPLETE', data: processedChats });
                } catch (err) { self.postMessage({ type: 'ERROR', message: err.message }); }
            }
        };
        `;

        // Centralized Keywords
        const KEYWORDS = {
            greetings: [
                'hello', 'hi', 'welcome', 'good morning', 'good afternoon', 'good evening', 
                'thank you for contacting', 'thanks for contacting', 'how can i help', 'my name is',
                'chatting with', 'pleasure to meet', 'reaching out', 'assist you today'
            ],
            empathy: [
                'sorry', 'apologize', 'understand', 'regret', 'unfortunate', 'frustrating', 
                'bear with me', 'my apologies', 'sorry for the inconvenience', 'i assure you',
                'totally understand', 'hear that', 'must be difficult', 'resolve this', 
                'on the same page', 'make this right', 'trouble you are facing'
            ],
            hold: [
                'hold', 'moment', 'check', 'bear with me', 'allow me to check', 'look into this', 
                'researching', 'brief hold', 'few minutes', 'consult', 'pull up', 'accessing', 
                'give me a second', 'quick check', 'grabbing that info'
            ],
            warranty: [
                'warranty', 'care', 'support', 'accessory', 'guarantee', 'repair', 'depot', 
                'onsite', 'accidental', 'damage', 'protection', 'sealed battery', 'keep your drive', 
                'adp', 'premier', 'upgrade warranty', 'warranty status', 'entitlement', 
                'base warranty', 'smart performance'
            ],
            accessories: [
                'mouse', 'keyboard', 'monitor', 'dock', 'charger', 'adapter', 'headset', 'bag', 
                'case', 'sleeve', 'cable', 'hub', 'webcam', 'stylus', 'pen', 'privacy filter', 
                'backpack', 'stand', 'speaker', 'hard drive', 'ssd', 'ram', 'memory', 'power bank'
            ],
            closing: [
                'anything else', 'further', 'assist you', 'other questions', 'help you with',
                'additional questions', 'support you', 'else i can do'
            ],
            profClosing: [
                'thank', 'bye', 'wonderful day', 'great day', 'rest of your day', 'take care', 
                'goodbye', 'appreciate your business', 'thanks for choosing'
            ],
            csat: [
                'survey', 'feedback', 'short survey', 'rate', 'experience', 'email', 
                'satisfaction', 'how i did', 'valued feedback'
            ],
            discovery: [
                '?', 'what', 'how', 'need', 'looking for', 'intend to use', 'purpose', 
                'usage', 'budget', 'preference', 'screen size', 'processor', 'storage', 
                'primary use', 'work', 'school', 'gaming'
            ],
            cxCritical: [
                'shut up', 'idiot', 'stupid', 'dumb', 'hate you', 'don\'t care', 'whatever', 
                'ridiculous', 'liar', 'waste of time'
            ],
            compCritical: [
                'credit card', 'cvv', 'card number', 'expiry', 'social security', 'ssn', 
                'password', 'login credentials'
            ]
        };

        const SCORECARD = {
            "Opening": [
                { id: "greet", text: "Agent greeted the customer professionally and introduced themselves", weight: 2.0 },
                { id: "confirm", text: "Agent confirmed the customer’s name and reason for contact", weight: 3.0 }
            ],
            "Communication": [
                { id: "listening", text: "Agent conversed actively without interrupting (Active Listening)", weight: 5.0 },
                { id: "clear", text: "Language was clear, professional, and free of jargon", weight: 5.0 },
                { id: "empathy", text: "Agent acknowledged customer concerns with empathy", weight: 5.0 },
                { id: "tone", text: "Tone was confident, professional, and engaging", weight: 2.0 },
                { id: "hold", text: "Agent applied correct hold etiquette", weight: 3.0 }
            ],
            "Solution/Sales": [
                { id: "discovery", text: "Agent asked relevant discovery questions to understand needs", weight: 7.5 },
                { id: "product", text: "Agent demonstrated strong product and service knowledge", weight: 7.5 },
                { id: "solution", text: "Agent offered the right solution based on identified needs", weight: 7.5 },
                { id: "objection", text: "Agent handled objections and highlighted competitive advantages", weight: 7.5 },
                { id: "warranty", text: "Agent clearly stated warranty benefits / Accessories", weight: 15.0 }
            ],
            "Process": [
                { id: "next_steps", text: "Agent confirmed next steps and call to action", weight: 5.0 },
                { id: "compliance", text: "Agent followed sales process and compliance guidelines", weight: 10.0 }
            ],
            "Closing": [
                { id: "transfer", text: "Agent performed transfer to correct queue (if applicable)", weight: 2.0 },
                { id: "disposition", text: "Agent applied correct disposition and CRM notes", weight: 4.0 },
                { id: "addressed", text: "Agent confirmed if the query was fully addressed", weight: 2.0 },
                { id: "end_prof", text: "Agent ended the interaction professionally", weight: 2.0 },
                { id: "csat", text: "Closing Csat Statement", weight: 5.0 }
            ]
        };

        const CRITICAL_TYPES = ["None", "CX Critical", "Compliance Critical", "Business Critical"];

        const CRITICAL_DEFINITIONS = {
            "CX Critical": [
                "Rude attitude or sarcasm.",
                "Providing misleading or wrong information.",
                "Chat Dumping (ending chat while customer is typing).",
                "Performing a wrong or invalid transfer."
            ],
            "Business Critical": [
                "Stacking or apply discounts improperly.",
                "Quoting unauthorized prices.",
                "Misrepresenting specifications."
            ],
            "Compliance Critical": [
                "PCI DSS: Asking for/accepting Credit Card info.",
                "GDPR: Sharing personal data."
            ]
        };

        // --- DEXIE DB SETUP ---
        const db = new Dexie('LenovoQA_DB');
        db.version(1).stores({
            chats: 'id, agent, date',
            surveys: 'id',
            reviews: 'id'
        });

        // --- UTILS ---

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => lucide.createIcons(), [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return new Date(0);
            const cleanStr = dateStr.trim();
            const parts = cleanStr.split(/[\/\-\s:TZ]/).filter(p => p !== ""); 
            if (parts.length >= 3) {
                let day, month, year, hours=0, minutes=0, seconds=0;
                if (parts[2].length === 4) { day = parseInt(parts[0], 10); month = parseInt(parts[1], 10) - 1; year = parseInt(parts[2], 10); if (parts.length >= 4) hours = parseInt(parts[3], 10); if (parts.length >= 5) minutes = parseInt(parts[4], 10); if (parts.length >= 6) seconds = parseInt(parts[5], 10); return new Date(year, month, day, hours, minutes, seconds); }
                if (parts[0].length === 4) { year = parseInt(parts[0], 10); month = parseInt(parts[1], 10) - 1; day = parseInt(parts[2], 10); if (parts.length >= 4) hours = parseInt(parts[3], 10); if (parts.length >= 5) minutes = parseInt(parts[4], 10); if (parts.length >= 6) seconds = parseInt(parts[5], 10); return new Date(year, month, day, hours, minutes, seconds); }
            }
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? new Date(0) : d;
        };

        const formatDate = (dateObj) => {
            if(!dateObj) return 'N/A';
            const d = typeof dateObj === 'string' ? new Date(dateObj) : dateObj;
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const formatTime = (dateStr) => {
            const d = parseDate(dateStr);
            if (isNaN(d.getTime())) return '';
            return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };
        
        const getLocalDateKey = (dateObj) => {
            if (!dateObj) return '1970-01-01';
            const d = typeof dateObj === 'string' ? new Date(dateObj) : dateObj;
            if (isNaN(d.getTime())) return '1970-01-01';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };

        // --- CHART COMPONENT ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                
                let chartInstance = null;
                const rafId = requestAnimationFrame(() => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                        chartRef.current = null;
                    }
                    const finalOptions = {
                        ...options,
                        plugins: {
                            ...options.plugins,
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold', size: 10 },
                                display: (context) => context.dataset.data[context.dataIndex] > 0,
                                formatter: (value) => value,
                                ...(options.plugins?.datalabels || {})
                            }
                        }
                    };
                    chartInstance = new Chart(canvasRef.current, { type, data, options: finalOptions });
                    chartRef.current = chartInstance;
                });

                return () => { 
                    cancelAnimationFrame(rafId);
                    if (chartRef.current) {
                        chartRef.current.destroy(); 
                        chartRef.current = null;
                    }
                };
            }, [type, data, options]);

            return <canvas ref={canvasRef} />;
        };

        // --- HIGHLIGHTER COMPONENT ---
        const HighlightedText = ({ text }) => {
            if (!text) return null;
            const positiveKeywords = [
                ...KEYWORDS.greetings, ...KEYWORDS.empathy, ...KEYWORDS.hold, 
                ...KEYWORDS.warranty, ...KEYWORDS.accessories, ...KEYWORDS.closing, 
                ...KEYWORDS.profClosing, ...KEYWORDS.csat, ...KEYWORDS.discovery
            ].filter(k => k.length > 1);
            const criticalKeywords = [...KEYWORDS.cxCritical, ...KEYWORDS.compCritical];
            const words = text.split(/(\s+)/);

            return (
                <span>
                    {words.map((word, i) => {
                        const lower = word.toLowerCase().replace(/[^a-z0-9]/g, '');
                        if (!lower) return <span key={i}>{word}</span>;
                        const isCritical = criticalKeywords.some(k => lower.includes(k));
                        const isPositive = !isCritical && positiveKeywords.some(k => lower === k || (k.length > 3 && lower.includes(k)));
                        if (isCritical) return <span key={i} className="bg-red-500/40 text-white font-bold rounded px-0.5 border border-red-500">{word}</span>;
                        if (isPositive) return <span key={i} className="bg-emerald-500/30 text-emerald-200 font-medium rounded px-0.5 border border-emerald-500/30">{word}</span>;
                        return <span key={i}>{word}</span>;
                    })}
                </span>
            );
        };

        // --- LOADING OVERLAY ---
        const LoadingOverlay = ({ progress, message, visible }) => (
            <div className={`fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-950/90 backdrop-blur-md transition-opacity duration-300 ${visible ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}>
                <div className="loader mb-6"></div>
                <h3 className="text-xl font-bold text-white mb-2">{message}</h3>
                <div className="w-64 h-2 bg-slate-800 rounded-full overflow-hidden">
                    <div className="h-full bg-lenovo-red transition-all duration-300" style={{ width: `${progress}%` }}></div>
                </div>
                <p className="text-slate-400 text-sm mt-2">{progress}% Complete</p>
            </div>
        );

        // --- MODAL COMPONENT ---
        const Modal = ({ isOpen, onClose, title, children, maxWidth = "max-w-lg" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className={`relative bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full ${maxWidth} overflow-hidden animate-fade-in`}>
                        <div className="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-800/50">
                            <h3 className="font-bold text-white text-lg">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto max-h-[80vh]">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white p-8 text-center font-sans">
                            <div className="max-w-xl bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-2xl">
                                <div className="text-lenovo-red mb-4 flex justify-center"><Icon name="alert-triangle" size={48} /></div>
                                <h1 className="text-3xl font-bold text-white mb-4">Something went wrong</h1>
                                <p className="text-slate-400 mb-6">The application encountered a critical error.</p>
                                <div className="p-4 bg-slate-950 rounded border border-slate-800 font-mono text-xs text-left overflow-auto max-h-40 mb-6 text-red-400">
                                    {this.state.error && this.state.error.toString()}
                                </div>
                                <button onClick={() => window.location.reload()} className="px-6 py-3 bg-lenovo-red text-white rounded-lg font-bold hover:bg-red-700 transition-colors w-full">Reload Application</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- MAIN APP COMPONENT ---

        const App = () => {
            // Data State
            const [chats, setChats] = useState([]);
            const [surveys, setSurveys] = useState({});
            const [qaData, setQaData] = useState({}); 
            const [storageError, setStorageError] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false);
            
            // Loading State
            const [isLoading, setIsLoading] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [loadingMessage, setLoadingMessage] = useState('');

            // UI State
            const [view, setView] = useState('upload'); 
            const [darkMode, setDarkMode] = useState(true);
            const [selectedChatId, setSelectedChatId] = useState(null);
            const [showCritInfo, setShowCritInfo] = useState(false);
            const [showHighRiskOnly, setShowHighRiskOnly] = useState(false);
            const [showTrendModal, setShowTrendModal] = useState(false);
            
            // Layer 4 & 5 UI State
            const [showAIPrompt, setShowAIPrompt] = useState(false);
            const [generatedPrompt, setGeneratedPrompt] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [loginPassword, setLoginPassword] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);
            
            // UPDATED: Check for default key & model & proxy
            const [apiKey, setApiKey] = useState(localStorage.getItem('lenovo_gemini_key') || DEFAULT_GEMINI_API_KEY || '');
            const [apiModel, setApiModel] = useState(localStorage.getItem('lenovo_gemini_model') || DEFAULT_GEMINI_MODEL);
            const [proxyUrl, setProxyUrl] = useState(localStorage.getItem('lenovo_proxy_url') || DEFAULT_PROXY_URL || '');
            
            // NEW: Custom Model Support
            const [useCustomModel, setUseCustomModel] = useState(false);
            const [customModelName, setCustomModelName] = useState('');

            const [isAIProcessing, setIsAIProcessing] = useState(false);

            const [filters, setFilters] = useState({
                startDate: '',
                endDate: '',
                agents: new Set(CORE_AGENTS),
                sampleMode: false,
                sampleSize: 3
            });

            const [trendAgent, setTrendAgent] = useState('All Agents');

            // --- WORKER REF ---
            const workerRef = useRef(null);

            // 0. INIT WORKER
            useEffect(() => {
                const blob = new Blob([WORKER_CODE], { type: 'application/javascript' });
                workerRef.current = new Worker(URL.createObjectURL(blob));
                
                workerRef.current.onmessage = (e) => {
                    const { type, data, value, message } = e.data;
                    if (type === 'PROGRESS') {
                        setLoadingProgress(value);
                        setLoadingMessage(message);
                    } else if (type === 'COMPLETE') {
                        // Data comes back from worker structured-cloned (Dates preserved)
                        setChats(prev => [...prev, ...data]);
                        setTimeout(() => setIsLoading(false), 200);
                    } else if (type === 'ERROR') {
                        console.error("Worker Error:", message);
                        setIsLoading(false);
                        alert("Error processing file: " + message);
                    }
                };

                return () => {
                    if (workerRef.current) workerRef.current.terminate();
                };
            }, []);

            // 1. LOAD DATA ON MOUNT
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const [storedChats, storedSurveys, storedReviews] = await Promise.all([
                            db.chats.toArray(),
                            db.surveys.toArray(),
                            db.reviews.toArray()
                        ]);

                        if (storedChats.length > 0) {
                            setChats(storedChats);
                            setView('workspace');
                        }
                        if (storedSurveys.length > 0) {
                            const sObj = {};
                            storedSurveys.forEach(s => sObj[s.id] = s.data);
                            setSurveys(sObj);
                        }
                        if (storedReviews.length > 0) {
                            const rObj = {};
                            storedReviews.forEach(r => rObj[r.id] = r.data);
                            setQaData(rObj);
                        }
                    } catch (err) {
                        console.error("Failed to load from IndexedDB", err);
                        setStorageError("Failed to load saved data. Your browser may be blocking storage.");
                    } finally {
                        setIsLoaded(true);
                    }
                };
                loadData();
            }, []);

            // 2. SAVE CHATS
            useEffect(() => {
                if (!isLoaded || chats.length === 0) return;
                const saveChats = async () => {
                    try {
                        await db.chats.clear(); 
                        await db.chats.bulkPut(chats);
                    } catch (e) {
                        console.error("IDB Save Chats Error", e);
                        setStorageError("Failed to save chats to disk.");
                    }
                };
                const t = setTimeout(saveChats, 500);
                return () => clearTimeout(t);
            }, [chats, isLoaded]);

            // 3. SAVE SURVEYS
            useEffect(() => {
                if (!isLoaded || Object.keys(surveys).length === 0) return;
                const saveSurveys = async () => {
                    try {
                        const surveyArray = Object.entries(surveys).map(([id, data]) => ({ id, data }));
                        await db.surveys.clear();
                        await db.surveys.bulkPut(surveyArray);
                    } catch (e) {
                        console.error("IDB Save Surveys Error", e);
                    }
                };
                const t = setTimeout(saveSurveys, 1000);
                return () => clearTimeout(t);
            }, [surveys, isLoaded]);

            // 4. SAVE REVIEWS
            useEffect(() => {
                if (!isLoaded || Object.keys(qaData).length === 0) return;
                const saveReviews = async () => {
                    try {
                        const reviewArray = Object.entries(qaData).map(([id, data]) => ({ id, data }));
                        await db.reviews.bulkPut(reviewArray);
                    } catch (e) {
                        console.error("IDB Save Reviews Error", e);
                    }
                };
                const t = setTimeout(saveReviews, 1000);
                return () => clearTimeout(t);
            }, [qaData, isLoaded]);

            const clearData = async () => {
                try {
                    await Promise.all([db.chats.clear(), db.surveys.clear(), db.reviews.clear()]);
                    setChats([]);
                    setSurveys({});
                    setQaData({});
                    setStorageError(null);
                    setView('upload');
                } catch (e) {
                    console.error("Failed to clear DB", e);
                }
            };

            const saveSettings = () => {
                localStorage.setItem('lenovo_gemini_key', apiKey);
                localStorage.setItem('lenovo_proxy_url', proxyUrl); // Save Proxy
                if (useCustomModel && customModelName) {
                     localStorage.setItem('lenovo_gemini_model', customModelName);
                     setApiModel(customModelName);
                } else {
                     localStorage.setItem('lenovo_gemini_model', apiModel);
                }
                setShowSettings(false);
            };

            const handleSettingsClick = () => {
                if (isAdmin) {
                    setShowSettings(true);
                } else {
                    setShowLogin(true);
                }
            };

            const handleAdminLogin = () => {
                if (loginPassword === ADMIN_PASSWORD) {
                    setIsAdmin(true);
                    setShowLogin(false);
                    setShowSettings(true);
                } else {
                    alert("Incorrect Password");
                }
            };

            useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
                document.documentElement.classList.toggle('light', !darkMode);
            }, [darkMode]);

            // --- LOGIC: PARSING & PROCESSING ---

            const handleFileUpload = (e, type) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;

                setIsLoading(true);
                setLoadingMessage(`Preparing ${files.length} file(s)...`);
                setLoadingProgress(0);

                if (type === 'chats') {
                    if (workerRef.current) {
                        workerRef.current.postMessage({ type: 'PROCESS_CHATS', payload: files });
                    } else {
                        alert("Worker not initialized.");
                        setIsLoading(false);
                    }
                } else {
                    files.forEach(file => {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                processSurveyRows(results.data);
                                setIsLoading(false);
                            }
                        });
                    });
                }
            };

            const processSurveyRows = (rows) => {
                const newSurveys = { ...surveys };
                rows.forEach(row => {
                    const id = row['Conversation ID'] || row.chatid;
                    if (!id) return;
                    if (!newSurveys[id]) newSurveys[id] = [];
                    newSurveys[id].push({
                        question: row['Survey Question'],
                        answer: row['Survey Answer'],
                        score: row['Survey Score']
                    });
                });
                setSurveys(newSurveys);
            };

            const calculateScore = (criteria, criticalFail) => {
                if (criticalFail && criticalFail !== "None") return 0;
                let totalW = 0, earnedW = 0;
                Object.entries(criteria).forEach(([k, v]) => {
                    if (v === 'N/A') return;
                    const weight = Object.values(SCORECARD).flat().find(i => i.id === k)?.weight || 0;
                    totalW += weight;
                    if (v === 'Yes') earnedW += weight;
                });
                return totalW === 0 ? 0 : Math.round((earnedW / totalW) * 100);
            };

            // Phase-Based Analysis (Logic/Fallback) -> Reverted to Global Search
            const analyzeChat = (chat) => {
                const msgs = chat.messages;
                // Flattened analysis - scanning entire chat instead of specific phases
                const allAgent = msgs.filter(m => m.type === 'agent');
                
                const criteria = {};
                let criticalFail = "None";
                let criticalReason = "";

                // --- SCORING (GLOBAL SEARCH) ---

                // 1. OPENING
                // Check first few messages for greeting
                const hasGreeting = allAgent.slice(0, 3).some(m => m.intent === 'Greeting' || KEYWORDS.greetings.some(k => m.text.toLowerCase().includes(k)));
                criteria.greet = hasGreeting ? 'Yes' : 'No';
                criteria.confirm = 'Yes'; 

                // 2. COMMUNICATION
                criteria.listening = 'Yes'; 
                criteria.clear = 'Yes'; 
                
                if (chat.flags && chat.flags.sentimentDrop) {
                    const hasEmpathy = allAgent.some(m => m.intent === 'Empathy' || KEYWORDS.empathy.some(k => m.text.toLowerCase().includes(k)));
                    criteria.empathy = hasEmpathy ? 'Yes' : 'No';
                } else {
                    criteria.empathy = 'N/A';
                }

                criteria.tone = 'Yes';
                
                const hasHold = allAgent.some(m => KEYWORDS.hold.some(k => m.text.toLowerCase().includes(k)));
                criteria.hold = hasHold ? 'Yes' : 'N/A';
                if (hasHold) {
                     criteria.hold = 'Yes';
                }

                // 3. SOLUTION / SALES
                // Check entire conversation for questions
                const discoveryQuestions = allAgent.filter(m => m.intent === 'Question' || m.text.includes('?'));
                criteria.discovery = discoveryQuestions.length >= 2 ? 'Yes' : 'No';

                criteria.product = 'Yes';
                criteria.solution = 'Yes';
                criteria.objection = 'Yes';

                // Check entire conversation for warranty
                const warrantyMentions = allAgent.some(m => 
                    m.intent === 'Warranty' || KEYWORDS.warranty.some(k => m.text.toLowerCase().includes(k))
                );
                criteria.warranty = warrantyMentions ? 'Yes' : 'No';

                // 4. PROCESS
                criteria.next_steps = 'Yes';
                criteria.compliance = 'Yes';

                // 5. CLOSING
                const isTransfer = allAgent.some(m => m.text.toLowerCase().includes('transfer') || m.text.toLowerCase().includes('connect you'));
                criteria.transfer = isTransfer ? 'Yes' : 'N/A';

                criteria.disposition = 'Yes';
                
                // Check last few messages for closing elements
                const closingMsgs = allAgent.slice(-5);
                
                const closingIntent = closingMsgs.some(m => m.intent === 'Closing' || KEYWORDS.closing.some(k => m.text.toLowerCase().includes(k)));
                criteria.addressed = closingIntent ? 'Yes' : 'No';
                
                criteria.end_prof = closingMsgs.some(m => KEYWORDS.profClosing.some(k => m.text.toLowerCase().includes(k))) ? 'Yes' : 'No';
                criteria.csat = closingMsgs.some(m => KEYWORDS.csat.some(k => m.text.toLowerCase().includes(k))) ? 'Yes' : 'No';

                // --- CRITICAL FAIL CHECKS ---
                const cxTrigger = allAgent.some(m => KEYWORDS.cxCritical.some(k => m.text.toLowerCase().includes(k)));
                if (cxTrigger) {
                    criticalFail = 'CX Critical';
                    criticalReason = 'Detected forbidden vocabulary.';
                }

                const compTrigger = allAgent.some(m => KEYWORDS.compCritical.some(k => m.text.toLowerCase().includes(k)));
                if (compTrigger) {
                    criticalFail = 'Compliance Critical';
                    criticalReason = 'Detected sensitive PII request.';
                }

                const score = calculateScore(criteria, criticalFail);

                return { 
                    criteria, 
                    score, 
                    criticalFail, 
                    criticalReason, 
                    status: 'AI',
                    flags: chat.flags,
                    flowScore: chat.flowScore
                };
            };

            const runBatchAnalysisChunked = () => {
                setIsLoading(true);
                setLoadingMessage('Analyzing conversations...');
                setLoadingProgress(0);

                const newData = { ...qaData };
                const chatsToAnalyze = filteredChats.filter(chat => !newData[chat.id] || newData[chat.id].status === 'AI');
                
                const total = chatsToAnalyze.length;
                if (total === 0) {
                    setIsLoading(false);
                    return;
                }

                const CHUNK_SIZE = 200; 
                let index = 0;

                const analyzeNextChunk = () => {
                    const end = Math.min(index + CHUNK_SIZE, total);
                    for (let i = index; i < end; i++) {
                        const chat = chatsToAnalyze[i];
                        newData[chat.id] = analyzeChat(chat);
                    }
                    index = end;
                    setLoadingProgress(Math.round((index / total) * 100));

                    if (index < total) {
                        setTimeout(analyzeNextChunk, 0);
                    } else {
                        setQaData(newData);
                        setTimeout(() => setIsLoading(false), 100);
                    }
                };
                setTimeout(analyzeNextChunk, 0);
            };

            // --- LAYER 5: REAL GEMINI INTEGRATION ---
            const analyzeWithGemini = async (chatId) => {
                // If proxy is set, priority use that
                const useProxy = !!proxyUrl;

                if (!useProxy && !apiKey) {
                    handleSettingsClick(); // Replaced setShowSettings(true) to trigger login check if needed, though handleAutoScore handles that
                    return;
                }

                const chat = chats.find(c => c.id === chatId);
                if (!chat) return;

                setIsAIProcessing(true);
                const { system, user } = constructAIPayload(chat);
                const modelToUse = (useCustomModel && customModelName) ? customModelName : (apiModel || DEFAULT_GEMINI_MODEL);

                try {
                    let response;
                    let data;

                    if (useProxy) {
                         // PROXY PATH
                         response = await fetch(proxyUrl, {
                             method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ 
                                 userPrompt: user, 
                                 systemPrompt: system, 
                                 model: modelToUse 
                             })
                         });
                    } else {
                        // DIRECT API PATH
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: system + "\n\n" + user }] }],
                                generationConfig: { responseMimeType: "application/json" }
                            })
                        });
                    }

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        const msg = err.error?.message || `API Error: ${response.status} ${response.statusText}`;
                        
                        if (msg.includes('location')) throw new Error('Gemini API is not available in your region/location.');
                        if (msg.includes('API key')) throw new Error('Invalid API Key.');
                        if (msg.includes('not found')) throw new Error(`Model '${modelToUse}' not found. Check settings.`);
                        if (msg.includes('fetch')) throw new Error('Network Blocked. If using direct API, try the Proxy URL option in settings.');
                        
                        throw new Error(msg);
                    }

                    data = await response.json();
                    
                    // Safety check for candidates
                    if (!data.candidates || data.candidates.length === 0) {
                        throw new Error('AI returned no content. Safety filters may have blocked it.');
                    }

                    const text = data.candidates[0].content.parts[0].text;
                    const jsonResult = JSON.parse(text);

                    // Update State with AI Data (Human-in-the-Loop: Status = 'AI_PROPOSED')
                    const newScore = calculateScore(jsonResult.criteria_scores, jsonResult.critical_fail);
                    
                    setQaData(prev => ({
                        ...prev,
                        [chatId]: {
                            ...prev[chatId],
                            criteria: jsonResult.criteria_scores,
                            score: newScore,
                            criticalFail: jsonResult.critical_fail,
                            criticalReason: jsonResult.critical_reason,
                            aiReasoning: jsonResult.reasoning, 
                            summary: jsonResult.summary,
                            coaching: jsonResult.coaching_tip,
                            status: 'AI_PROPOSED' // Yellow Flag
                        }
                    }));

                } catch (e) {
                    console.error("AI Error", e);
                    if (e.message === 'Failed to fetch') {
                        alert(`AI Analysis Failed: Network Error.\n\n1. Check internet.\n2. Google APIs might be blocked by your network.\n3. Try setting up the Cloudflare Proxy (Option 1).`);
                    } else {
                        alert("AI Analysis Failed: " + e.message);
                    }
                } finally {
                    setIsAIProcessing(false);
                }
            };

            const constructAIPayload = (chat) => {
                const system = AI_PROMPTS.system;
                const user = AI_PROMPTS.userTemplate(chat, SCORECARD);
                return { system, user };
            };

            const handleAutoScore = (chatId) => {
                if (apiKey || proxyUrl) {
                    analyzeWithGemini(chatId);
                } else {
                    handleSettingsClick(); // Ensure auth check happens
                }
            };

            const handleOpenAIPrompt = (chatId) => {
                const chat = chats.find(c => c.id === chatId);
                if (!chat) return;
                const { system, user } = constructAIPayload(chat);
                setGeneratedPrompt(`=== SYSTEM PROMPT ===\n${system}\n\n=== USER PROMPT ===\n${user}`);
                setShowAIPrompt(true);
            };

            const updateCriterion = (chatId, criterionId, value) => {
                setQaData(prev => {
                    const currentChatData = prev[chatId] || analyzeChat(chats.find(c => c.id === chatId));
                    const newCriteria = { ...currentChatData.criteria, [criterionId]: value };
                    const newScore = calculateScore(newCriteria, currentChatData.criticalFail);
                    
                    return {
                        ...prev,
                        [chatId]: {
                            ...currentChatData,
                            criteria: newCriteria,
                            score: newScore,
                        }
                    };
                });
            };

            const updateCritical = (chatId, value) => {
                setQaData(prev => {
                    const currentChatData = prev[chatId] || analyzeChat(chats.find(c => c.id === chatId));
                    const newScore = calculateScore(currentChatData.criteria, value);
                    
                    return {
                        ...prev,
                        [chatId]: {
                            ...currentChatData,
                            criticalFail: value,
                            criticalReason: value === 'None' ? '' : 'Manual Override',
                            score: newScore
                        }
                    };
                });
            };

            const saveReview = (chatId) => {
                setQaData(prev => ({
                    ...prev,
                    [chatId]: {
                        ...prev[chatId],
                        status: 'Reviewed'
                    }
                }));
            };

            const resetReview = (chatId) => {
                const originalAnalysis = analyzeChat(chats.find(c => c.id === chatId));
                setQaData(prev => ({
                    ...prev,
                    [chatId]: originalAnalysis
                }));
            };

            const generateDailySample = (count) => {
                setFilters(prev => ({ ...prev, sampleMode: true, sampleSize: count }));
            };

            const filteredChats = useMemo(() => {
                let result = chats.filter(c => {
                    const chatDateStr = getLocalDateKey(c.date);
                    if (filters.startDate && chatDateStr < filters.startDate) return false;
                    if (filters.endDate && chatDateStr > filters.endDate) return false;
                    if (!filters.agents.has(c.agent)) return false;
                    if (showHighRiskOnly && (!c.riskScore || c.riskScore <= 0)) return false;
                    return true;
                });

                if (filters.sampleMode) {
                    const buckets = {};
                    result.forEach(c => {
                        const day = getLocalDateKey(c.date);
                        const key = `${c.agent}|${day}`;
                        if (!buckets[key]) buckets[key] = [];
                        buckets[key].push(c);
                    });
                    const sampled = [];
                    Object.values(buckets).forEach(bucket => {
                        const shuffled = bucket.sort(() => 0.5 - Math.random());
                        sampled.push(...shuffled.slice(0, filters.sampleSize));
                    });
                    result = sampled;
                }
                return result;
            }, [chats, filters, showHighRiskOnly]); 

            const stats = useMemo(() => {
                const evaluated = filteredChats.filter(c => qaData[c.id]);
                const totalEvaluated = evaluated.length;
                const criticalChats = evaluated.filter(c => qaData[c.id].criticalFail && qaData[c.id].criticalFail !== "None");

                if (totalEvaluated === 0) return { avgScore: 0, totalEvaluated: 0, criticals: 0, agentStats: {}, dates: {}, criticalQueue: [], categoryScores: {} };

                const avgScore = Math.round(evaluated.reduce((acc, c) => acc + qaData[c.id].score, 0) / totalEvaluated);
                const criticals = criticalChats.length;

                const agentStats = {};
                evaluated.forEach(c => {
                    if (!agentStats[c.agent]) agentStats[c.agent] = { total: 0, count: 0, criticals: 0 };
                    agentStats[c.agent].total += qaData[c.id].score;
                    agentStats[c.agent].count++;
                    if (qaData[c.id].criticalFail && qaData[c.id].criticalFail !== "None") agentStats[c.agent].criticals++;
                });

                const dates = {};
                evaluated.forEach(c => {
                    const d = getLocalDateKey(c.date);
                    if (!dates[d]) dates[d] = { total: 0, count: 0 };
                    dates[d].total += qaData[c.id].score;
                    dates[d].count++;
                });

                const categoryTotals = {};
                const categoryCounts = {};
                evaluated.forEach(c => {
                    const q = qaData[c.id];
                    Object.entries(SCORECARD).forEach(([catName, criteriaList]) => {
                        if (!categoryTotals[catName]) { categoryTotals[catName] = 0; categoryCounts[catName] = 0; }
                        let catPossible = 0;
                        let catEarned = 0;
                        criteriaList.forEach(item => {
                            if (q.criteria[item.id] !== 'N/A') {
                                catPossible += item.weight;
                                if (q.criteria[item.id] === 'Yes') catEarned += item.weight;
                            }
                        });
                        if (catPossible > 0) {
                            const catScore = (catEarned / catPossible) * 100;
                            categoryTotals[catName] += catScore;
                            categoryCounts[catName]++;
                        }
                    });
                });

                const categoryScores = {};
                Object.keys(categoryTotals).forEach(cat => {
                    categoryScores[cat] = categoryCounts[cat] > 0 ? Math.round(categoryTotals[cat] / categoryCounts[cat]) : 0;
                });
                
                return { avgScore, totalEvaluated, criticals, agentStats, dates, criticalQueue: criticalChats, categoryScores };
            }, [filteredChats, qaData]);

            const trendStats = useMemo(() => {
                const evaluated = filteredChats.filter(c => qaData[c.id]);
                const dailyData = {};
                let maxCount = 0; 
                
                evaluated.forEach(c => {
                    if (trendAgent !== 'All Agents' && c.agent !== trendAgent) return;
                    const d = getLocalDateKey(c.date);
                    if (!dailyData[d]) dailyData[d] = { totalScore: 0, count: 0 };
                    dailyData[d].totalScore += qaData[c.id].score;
                    dailyData[d].count++;
                    if (dailyData[d].count > maxCount) maxCount = dailyData[d].count;
                });

                const sortedDates = Object.keys(dailyData).sort();
                return {
                    dates: sortedDates,
                    scores: sortedDates.map(d => dailyData[d].totalScore / dailyData[d].count),
                    counts: sortedDates.map(d => dailyData[d].count),
                    maxCount: maxCount
                };
            }, [filteredChats, qaData, trendAgent]);

            const exportCSV = () => {
                const headers = ['Date', 'Agent', 'Chat ID', 'Score', 'Review Status', 'Critical Fail', 'Critical Reason', 'CSAT', ...Object.values(SCORECARD).flat().map(c => c.text)];
                const rows = filteredChats.map(c => {
                    const qa = qaData[c.id] || { score: 0, criteria: {}, criticalFail: 'None', criticalReason: '', status: 'Pending' };
                    const survey = surveys[c.id] ? surveys[c.id][0]?.score : 'N/A';
                    return [
                        formatDate(c.date),
                        c.agent,
                        c.id,
                        qa.score + '%',
                        qa.status || 'AI',
                        qa.criticalFail || 'None',
                        qa.criticalReason || '',
                        survey,
                        ...Object.values(SCORECARD).flat().map(cri => qa.criteria[cri.id] || 'N/A')
                    ];
                });

                const csv = Papa.unparse([headers, ...rows]);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'Lenovo_QA_Report.csv';
                a.click();
            };

            if (view === 'upload') {
                return (
                    <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-slate-950">
                        <LoadingOverlay progress={loadingProgress} message={loadingMessage} visible={isLoading} />
                        
                        <div className="absolute inset-0 bg-slate-950">
                             <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                             <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-lenovo-red/10 rounded-full blur-[100px] translate-x-1/2 -translate-y-1/2"></div>
                             <div className="absolute bottom-0 left-0 w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[100px] -translate-x-1/2 translate-y-1/2"></div>
                        </div>

                        <div className="relative z-10 w-full max-w-4xl p-8">
                            <div className="text-center mb-12">
                                <div className="inline-flex mb-6 transform hover:scale-105 transition-transform duration-300">
                                    <div className="bg-lenovo-red text-white px-6 py-2 text-4xl font-sans font-bold tracking-wider rounded-sm shadow-xl shadow-lenovo-red/20">
                                        Lenovo
                                    </div>
                                </div>
                                <h1 className="text-4xl font-light text-white tracking-tight">QA Manager <span className="font-bold text-lenovo-red">Pro</span></h1>
                                <p className="text-slate-400 text-lg mt-3 font-light">Automated Intelligence for Quality Assurance</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="glass-panel p-8 rounded-2xl border border-slate-700 hover:border-lenovo-red/50 transition-all group cursor-pointer relative overflow-hidden">
                                    <input type="file" multiple className="absolute inset-0 opacity-0 cursor-pointer z-20" onChange={(e) => handleFileUpload(e, 'chats')} />
                                    <div className="relative z-10 flex flex-col items-center">
                                        <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4 group-hover:bg-lenovo-red transition-colors">
                                            <Icon name="message-square" className="text-white" size={24} />
                                        </div>
                                        <h3 className="text-xl font-semibold text-white">Upload Chats</h3>
                                        <p className="text-slate-500 text-sm mt-2 text-center">Drag & Drop CSV Logs</p>
                                        {chats.length > 0 && <span className="mt-4 px-3 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full font-mono">{chats.length} Loaded</span>}
                                    </div>
                                </div>
                                <div className="glass-panel p-8 rounded-2xl border border-slate-700 hover:border-blue-500/50 transition-all group cursor-pointer relative overflow-hidden">
                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer z-20" onChange={(e) => handleFileUpload(e, 'surveys')} />
                                    <div className="relative z-10 flex flex-col items-center">
                                        <div className="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mb-4 group-hover:bg-blue-600 transition-colors">
                                            <Icon name="file-bar-chart" className="text-white" size={24} />
                                        </div>
                                        <h3 className="text-xl font-semibold text-white">Link Surveys</h3>
                                        <p className="text-slate-500 text-sm mt-2 text-center">Match via Chat ID</p>
                                        {Object.keys(surveys).length > 0 && <span className="mt-4 px-3 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full font-mono">{Object.keys(surveys).length} Linked</span>}
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setView('workspace')} disabled={chats.length === 0} className={`mt-8 w-full py-4 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${chats.length > 0 ? 'bg-gradient-to-r from-lenovo-red to-lenovo-dark text-white shadow-xl shadow-lenovo-red/20 hover:scale-[1.01]' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>
                                Enter Workspace <Icon name="arrow-right" />
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`h-screen flex flex-col ${darkMode ? 'bg-slate-950' : 'bg-slate-100'} transition-colors`}>
                    <LoadingOverlay progress={loadingProgress} message={loadingMessage} visible={isLoading} />
                    
                    <Modal isOpen={showCritInfo} onClose={() => setShowCritInfo(false)} title="Critical Failure Definitions">
                        <div className="space-y-6">
                            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
                                <div className="flex items-center gap-2 mb-2 text-red-400 font-bold">
                                    <Icon name="alert-octagon" size={20} /> CX Critical
                                </div>
                                <ul className="list-disc list-inside text-xs text-slate-400 space-y-1 ml-2">
                                    {CRITICAL_DEFINITIONS["CX Critical"].map(d => <li key={d}>{d}</li>)}
                                </ul>
                            </div>
                            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
                                <div className="flex items-center gap-2 mb-2 text-amber-400 font-bold">
                                    <Icon name="briefcase" size={20} /> Business Critical
                                </div>
                                <ul className="list-disc list-inside text-xs text-slate-400 space-y-1 ml-2">
                                    {CRITICAL_DEFINITIONS["Business Critical"].map(d => <li key={d}>{d}</li>)}
                                </ul>
                            </div>
                            <div className="p-4 bg-slate-800 rounded-lg border border-slate-700">
                                <div className="flex items-center gap-2 mb-2 text-blue-400 font-bold">
                                    <Icon name="shield-alert" size={20} /> Compliance Critical
                                </div>
                                <ul className="list-disc list-inside text-xs text-slate-400 space-y-1 ml-2">
                                    {CRITICAL_DEFINITIONS["Compliance Critical"].map(d => <li key={d}>{d}</li>)}
                                </ul>
                            </div>
                        </div>
                    </Modal>

                    {/* NEW: Admin Login Modal */}
                    <Modal isOpen={showLogin} onClose={() => setShowLogin(false)} title="Admin Access Required" maxWidth="max-w-sm">
                         <div className="space-y-4">
                            <p className="text-sm text-slate-400">Settings are protected. Please enter the admin password to continue.</p>
                            <input 
                                type="password" 
                                value={loginPassword} 
                                onChange={(e) => setLoginPassword(e.target.value)} 
                                onKeyDown={(e) => e.key === 'Enter' && handleAdminLogin()}
                                className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-lenovo-red outline-none"
                                placeholder="Password"
                            />
                            <div className="flex justify-end pt-4">
                                <button onClick={handleAdminLogin} className="px-4 py-2 bg-lenovo-red text-white rounded font-bold hover:bg-red-700">Login</button>
                            </div>
                        </div>
                    </Modal>

                    {/* NEW: Full Trend Modal */}
                    <Modal isOpen={showTrendModal} onClose={() => setShowTrendModal(false)} title="Full Historical Trend" maxWidth="max-w-6xl">
                        <div className="h-[60vh] w-full">
                             <ChartComponent 
                                type="bar"
                                data={{
                                    labels: trendStats.dates,
                                    datasets: [
                                        {
                                            type: 'line',
                                            label: 'Avg Score',
                                            data: trendStats.scores,
                                            borderColor: '#E2231A',
                                            tension: 0.4,
                                            yAxisID: 'y',
                                            order: 1,
                                            borderWidth: 2,
                                            pointBackgroundColor: '#E2231A',
                                            datalabels: { align: 'top', anchor: 'end', formatter: (v) => Math.round(v) + '%' }
                                        },
                                        {
                                            type: 'bar',
                                            label: 'Chats Analyzed',
                                            data: trendStats.counts,
                                            backgroundColor: darkMode ? 'rgba(148, 163, 184, 0.5)' : 'rgba(203, 213, 225, 0.8)',
                                            yAxisID: 'y1',
                                            order: 2,
                                            borderRadius: 4,
                                            barThickness: 20,
                                            datalabels: { anchor: 'end', align: 'start', offset: -4, color: darkMode ? '#fff' : '#1e293b', font: { weight: 'bold', size: 11 }, formatter: (v) => v }
                                        }
                                    ]
                                }}
                                options={{ 
                                    maintainAspectRatio: false, 
                                    plugins: { legend: { display: true, labels: { color: darkMode ? '#94a3b8' : '#475569', font: {size: 10} } } },
                                    scales: { 
                                        y: { type: 'linear', display: true, position: 'left', min: 0, max: 100, title: { display: true, text: 'Score %', color: '#E2231A', font: {size: 10} }, grid: { color: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } },
                                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Volume', color: '#64748b', font: {size: 10} }, ticks: { stepSize: 1 }, suggestedMax: (context) => trendStats.maxCount ? trendStats.maxCount * 2 : 10 },
                                        x: { grid: { display: false } }
                                    } 
                                }}
                             />
                        </div>
                    </Modal>

                    {/* NEW: AI Prompt Preview Modal */}
                    <Modal isOpen={showAIPrompt} onClose={() => setShowAIPrompt(false)} title="AI Prompt Preview (Layer 4)" maxWidth="max-w-4xl">
                        <div className="flex flex-col h-[60vh]">
                            <div className="bg-slate-800 p-4 rounded-lg border border-slate-700 mb-4 flex-1 overflow-auto">
                                <pre className="text-xs text-green-400 font-mono whitespace-pre-wrap">{generatedPrompt}</pre>
                            </div>
                            <div className="flex justify-between items-center text-xs text-slate-500">
                                <span>This is the exact payload that will be sent to the LLM in Layer 5.</span>
                                <button className="px-4 py-2 bg-slate-700 text-white rounded hover:bg-slate-600" onClick={() => navigator.clipboard.writeText(generatedPrompt)}>Copy to Clipboard</button>
                            </div>
                        </div>
                    </Modal>

                    {/* NEW: Settings Modal */}
                    <Modal isOpen={showSettings} onClose={() => setShowSettings(false)} title="Settings" maxWidth="max-w-md">
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-400 mb-2">Gemini API Key</label>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={(e) => setApiKey(e.target.value)} 
                                    className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-lenovo-red outline-none"
                                    placeholder="Enter your API Key"
                                />
                                <p className="text-[10px] text-slate-500 mt-2">
                                    Your key is stored locally in your browser. To set for everyone, update the HTML source code.
                                </p>
                            </div>
                            
                            {/* NEW: Cloudflare Proxy Input */}
                            <div>
                                <label className="block text-sm font-bold text-slate-400 mb-2">Cloudflare Proxy URL (Recommended)</label>
                                <input 
                                    type="text" 
                                    value={proxyUrl} 
                                    onChange={(e) => setProxyUrl(e.target.value)} 
                                    className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-lenovo-red outline-none"
                                    placeholder="https://your-worker-name.workers.dev"
                                />
                                <p className="text-[10px] text-slate-500 mt-2">
                                    Paste your Cloudflare Worker URL here to fix "Network Error" and CORS issues.
                                </p>
                            </div>

                            {/* New: Model Selector */}
                            <div>
                                <label className="block text-sm font-bold text-slate-400 mb-2">Gemini Model</label>
                                <div className="space-y-2">
                                    <div className="flex gap-2">
                                        <button 
                                            className={`px-3 py-1.5 rounded text-xs border ${!useCustomModel ? 'bg-lenovo-red text-white border-lenovo-red' : 'bg-slate-800 border-slate-600 text-slate-300'}`}
                                            onClick={() => setUseCustomModel(false)}
                                        >
                                            Standard List
                                        </button>
                                        <button 
                                            className={`px-3 py-1.5 rounded text-xs border ${useCustomModel ? 'bg-lenovo-red text-white border-lenovo-red' : 'bg-slate-800 border-slate-600 text-slate-300'}`}
                                            onClick={() => setUseCustomModel(true)}
                                        >
                                            Custom Model Name
                                        </button>
                                    </div>

                                    {!useCustomModel ? (
                                        <select 
                                            value={apiModel} 
                                            onChange={(e) => setApiModel(e.target.value)}
                                            className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-lenovo-red outline-none"
                                        >
                                            <option value="gemini-2.5-flash">Gemini 2.5 Flash (New)</option>
                                            <option value="gemini-1.5-flash-001">Gemini 1.5 Flash (Stable)</option>
                                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (Alias)</option>
                                            <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8b</option>
                                            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                                        </select>
                                    ) : (
                                        <input 
                                            type="text" 
                                            value={customModelName} 
                                            onChange={(e) => setCustomModelName(e.target.value)} 
                                            className="w-full bg-slate-800 border border-slate-700 text-white rounded p-2 focus:ring-2 focus:ring-lenovo-red outline-none"
                                            placeholder="e.g. gemini-2.5-flash"
                                        />
                                    )}
                                </div>
                            </div>
                            <div className="flex justify-end pt-4">
                                <button onClick={saveSettings} className="px-4 py-2 bg-lenovo-red text-white rounded font-bold hover:bg-red-700">Save Settings</button>
                            </div>
                        </div>
                    </Modal>

                    {storageError && (
                        <div className="bg-red-600 text-white text-xs font-bold text-center py-2 px-4 shadow-lg flex items-center justify-center gap-2 relative z-50 animate-fade-in">
                            <Icon name="alert-circle" size={14} />
                            {storageError}
                            <button onClick={() => setStorageError(null)} className="absolute right-4 hover:opacity-75"><Icon name="x" size={14} /></button>
                        </div>
                    )}

                    <nav className={`h-16 border-b flex items-center justify-between px-6 z-30 ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                        <div className="flex items-center gap-4">
                            <div className="bg-lenovo-red text-white px-2 py-1 text-lg font-bold tracking-wider rounded-sm">Lenovo</div>
                            <span className={`font-light text-lg ${darkMode ? 'text-white' : 'text-slate-800'}`}>QA Manager</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => handleSettingsClick()} className="p-2 rounded-full hover:bg-slate-800 transition-colors text-slate-400" title="Settings">
                                <Icon name="settings" size={18} />
                            </button>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-slate-800 transition-colors text-slate-400">
                                <Icon name={darkMode ? "sun" : "moon"} size={18} />
                            </button>
                        </div>
                    </nav>

                    <div className="flex-1 flex overflow-hidden">
                        <aside className={`w-80 border-r flex flex-col z-20 ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                            <div className="p-4 space-y-4 border-b border-slate-800">
                                {chats.length > 0 && (
                                    <button onClick={clearData} className="w-full py-2 border border-red-500/50 text-red-500 hover:bg-red-500/10 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-2">
                                        <Icon name="trash-2" size={12} /> Clear Saved Data
                                    </button>
                                )}
                                <button
                                    onClick={() => setShowHighRiskOnly(!showHighRiskOnly)}
                                    className={`w-full py-2 mb-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                                        showHighRiskOnly
                                        ? 'bg-red-500 text-white shadow-lg shadow-red-900/20'
                                        : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                    }`}
                                >
                                    <Icon name="siren" size={14} />
                                    {showHighRiskOnly ? 'Showing High Risk' : 'Show High Risk Only'}
                                </button>

                                <div className="space-y-2">
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Date Range</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="date" className={`w-full rounded-lg px-2 py-1.5 text-xs border focus:outline-none focus:ring-1 focus:ring-lenovo-red ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-50 border-slate-300 text-slate-800'}`} onChange={e => setFilters(prev => ({...prev, startDate: e.target.value}))} />
                                        <input type="date" className={`w-full rounded-lg px-2 py-1.5 text-xs border focus:outline-none focus:ring-1 focus:ring-lenovo-red ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-50 border-slate-300 text-slate-800'}`} onChange={e => setFilters(prev => ({...prev, endDate: e.target.value}))} />
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Agents</label>
                                    <div className={`max-h-32 overflow-y-auto rounded-lg border p-1 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-300'}`}>
                                        {CORE_AGENTS.map(agent => (
                                            <label key={agent} className="flex items-center gap-2 p-1.5 hover:bg-slate-700/50 rounded cursor-pointer">
                                                <input type="checkbox" checked={filters.agents.has(agent)} onChange={() => {
                                                    const newSet = new Set(filters.agents);
                                                    if (newSet.has(agent)) newSet.delete(agent); else newSet.add(agent);
                                                    setFilters(prev => ({...prev, agents: newSet}));
                                                }} className="rounded border-slate-600 text-lenovo-red focus:ring-0" />
                                                <span className={`text-xs ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>{agent}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex flex-col gap-2">
                                    <label className="text-[10px] uppercase font-bold text-slate-500">Actions</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => generateDailySample(3)} className="py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-bold shadow-lg flex items-center justify-center gap-1">
                                            <Icon name="dices" size={12} /> Sample 3
                                        </button>
                                        <button onClick={() => generateDailySample(5)} className="py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-bold shadow-lg flex items-center justify-center gap-1">
                                            <Icon name="dices" size={12} /> Sample 5
                                        </button>
                                    </div>
                                    <button onClick={runBatchAnalysisChunked} className="py-2 bg-lenovo-red hover:bg-lenovo-dark text-white rounded-lg text-xs font-bold shadow-lg shadow-red-900/20 flex items-center justify-center gap-1 w-full mt-1">
                                        <Icon name="brain-circuit" size={12} /> Auto-Score All
                                    </button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {filteredChats.slice(0, 100).map(chat => {
                                    const data = qaData[chat.id];
                                    const score = data?.score;
                                    const critical = data?.criticalFail;
                                    const isCrit = critical && critical !== "None";
                                    const isReviewed = data?.status === 'Reviewed';
                                    const isAIProposed = data?.status === 'AI_PROPOSED';
                                    const isHighRisk = chat.riskScore > 0;

                                    return (
                                        <div key={chat.id} onClick={() => setSelectedChatId(chat.id)} className={`p-4 border-b cursor-pointer transition-all hover:pl-5 ${darkMode ? 'border-slate-800 hover:bg-slate-800' : 'border-slate-100 hover:bg-slate-50'} ${selectedChatId === chat.id ? 'border-l-4 border-l-lenovo-red bg-slate-800/50' : 'border-l-4 border-l-transparent'}`}>
                                            <div className="flex justify-between items-start mb-1">
                                                <div className="flex items-center gap-2">
                                                    {isHighRisk && <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>}
                                                    <span className={`font-medium text-sm ${darkMode ? 'text-slate-200' : 'text-slate-800'}`}>{chat.agent}</span>
                                                    {isReviewed && <Icon name="check-circle" size={12} className="text-emerald-500" />}
                                                    {isAIProposed && <Icon name="sparkles" size={12} className="text-indigo-400" />}
                                                </div>
                                                {score !== undefined && (
                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${isCrit ? 'bg-red-500/20 text-red-500' : isAIProposed ? 'bg-indigo-500/20 text-indigo-400' : score >= 85 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`}>
                                                        {score}%
                                                    </span>
                                                )}
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <div className="text-xs text-slate-500 font-mono">{formatDate(chat.date)}</div>
                                                <div className="text-[10px] text-slate-600">#{chat.id.substring(0,6)}...</div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </aside>

                        <main className="flex-1 overflow-y-auto relative p-6">
                            {!selectedChatId && (
                                <div className="max-w-6xl mx-auto space-y-6 animate-fade-in">
                                    <header className="flex justify-between items-end mb-8">
                                        <div>
                                            <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>Dashboard</h2>
                                            <p className="text-slate-400">Analysis of {filteredChats.length} conversations</p>
                                        </div>
                                        {stats.totalEvaluated > 0 && <button onClick={exportCSV} className="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-slate-700 flex items-center gap-2"><Icon name="download" size={14}/> Export CSV</button>}
                                    </header>

                                    {stats.criticalQueue.length > 0 && (
                                        <div className="mb-8 p-6 rounded-2xl bg-red-900/10 border border-red-500/30">
                                            <div className="flex items-center gap-2 mb-4">
                                                <div className="p-1.5 bg-red-500 rounded-lg text-white animate-pulse"><Icon name="siren" size={16}/></div>
                                                <h3 className="text-lg font-bold text-red-500">Critical Alerts Queue</h3>
                                                <span className="px-2 py-0.5 bg-red-500/20 text-red-400 rounded-full text-xs font-mono">{stats.criticalQueue.length} Chats</span>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                                {stats.criticalQueue.slice(0, 6).map(c => (
                                                    <div key={c.id} className="bg-slate-900 border border-red-500/20 p-3 rounded-lg flex justify-between items-center group hover:border-red-500/50 transition-colors">
                                                        <div>
                                                            <div className="text-sm font-bold text-slate-200">{c.agent}</div>
                                                            <div className="text-xs text-red-400 font-mono">Type: {qaData[c.id].criticalFail}</div>
                                                        </div>
                                                        <button onClick={() => setSelectedChatId(c.id)} className="px-3 py-1.5 bg-red-500/20 text-red-400 text-xs font-bold rounded hover:bg-red-500 hover:text-white transition-colors">Review</button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {stats.totalEvaluated > 0 ? (
                                        <>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div className="p-2 rounded-lg bg-blue-500/10 text-blue-500"><Icon name="activity" /></div>
                                                        <span className="text-xs font-bold uppercase text-slate-500">Avg Score</span>
                                                    </div>
                                                    <div className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>{stats.avgScore}%</div>
                                                </div>
                                                <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div className="p-2 rounded-lg bg-red-500/10 text-red-500"><Icon name="alert-triangle" /></div>
                                                        <span className="text-xs font-bold uppercase text-slate-500">Critical Fails</span>
                                                    </div>
                                                    <div className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>{stats.criticals}</div>
                                                </div>
                                                <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div className="p-2 rounded-lg bg-emerald-500/10 text-emerald-500"><Icon name="check-circle" /></div>
                                                        <span className="text-xs font-bold uppercase text-slate-500">Analyzed</span>
                                                    </div>
                                                    <div className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>{stats.totalEvaluated}</div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                    <div className="flex justify-between items-center mb-4">
                                                        <div className="flex items-center gap-2">
                                                            <h3 className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>Score Trend & Volume</h3>
                                                            <button onClick={() => setShowTrendModal(true)} className="text-slate-500 hover:text-lenovo-red transition-colors" title="View Full Trend">
                                                                <Icon name="maximize-2" size={16} />
                                                            </button>
                                                        </div>
                                                        <select 
                                                            value={trendAgent} 
                                                            onChange={(e) => setTrendAgent(e.target.value)}
                                                            className={`text-xs p-1.5 rounded border ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-300 text-slate-800'}`}
                                                        >
                                                            <option>All Agents</option>
                                                            {CORE_AGENTS.map(a => <option key={a}>{a}</option>)}
                                                        </select>
                                                    </div>
                                                    <div className="h-64">
                                                        <ChartComponent 
                                                            type="bar"
                                                            data={{
                                                                labels: trendStats.dates.slice(-7),
                                                                datasets: [
                                                                    {
                                                                        type: 'line',
                                                                        label: 'Avg Score',
                                                                        data: trendStats.scores.slice(-7),
                                                                        borderColor: '#E2231A',
                                                                        tension: 0.4,
                                                                        yAxisID: 'y',
                                                                        order: 1,
                                                                        borderWidth: 2,
                                                                        pointBackgroundColor: '#E2231A',
                                                                        datalabels: { align: 'top', anchor: 'end', formatter: (v) => Math.round(v) + '%' }
                                                                    },
                                                                    {
                                                                        type: 'bar',
                                                                        label: 'Chats Analyzed',
                                                                        data: trendStats.counts.slice(-7),
                                                                        backgroundColor: darkMode ? 'rgba(148, 163, 184, 0.5)' : 'rgba(203, 213, 225, 0.8)',
                                                                        yAxisID: 'y1',
                                                                        order: 2,
                                                                        borderRadius: 4,
                                                                        barThickness: 20,
                                                                        datalabels: { anchor: 'end', align: 'start', offset: -4, color: darkMode ? '#fff' : '#1e293b', font: { weight: 'bold', size: 11 }, formatter: (v) => v }
                                                                    }
                                                                ]
                                                            }}
                                                            options={{ 
                                                                maintainAspectRatio: false, 
                                                                plugins: { legend: { display: true, labels: { color: darkMode ? '#94a3b8' : '#475569', font: {size: 10} } } },
                                                                scales: { 
                                                                    y: { type: 'linear', display: true, position: 'left', min: 0, max: 100, title: { display: true, text: 'Score %', color: '#E2231A', font: {size: 10} }, grid: { color: darkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } },
                                                                    y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Volume', color: '#64748b', font: {size: 10} }, ticks: { stepSize: 1 }, suggestedMax: (context) => trendStats.maxCount ? trendStats.maxCount * 2 : 10 },
                                                                    x: { grid: { display: false } }
                                                                } 
                                                            }}
                                                        />
                                                    </div>
                                                </div>

                                                <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                    <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-slate-800'}`}>Category Strengths</h3>
                                                    <div className="h-64 flex justify-center">
                                                        <ChartComponent 
                                                            type="radar"
                                                            data={{
                                                                labels: Object.keys(stats.categoryScores),
                                                                datasets: [{
                                                                    label: 'Team Average',
                                                                    data: Object.values(stats.categoryScores),
                                                                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                                                    borderColor: '#3b82f6',
                                                                    pointBackgroundColor: '#3b82f6',
                                                                    pointBorderColor: '#fff',
                                                                    pointHoverBackgroundColor: '#fff',
                                                                    pointHoverBorderColor: '#3b82f6'
                                                                }]
                                                            }}
                                                            options={{
                                                                maintainAspectRatio: false,
                                                                scales: {
                                                                    r: {
                                                                        angleLines: { color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                                                                        grid: { color: darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' },
                                                                        pointLabels: { color: darkMode ? '#cbd5e1' : '#475569', font: { size: 11, weight: 'bold' } },
                                                                        ticks: { backdropColor: 'transparent', color: 'transparent', stepSize: 20 },
                                                                        min: 0, max: 100
                                                                    }
                                                                },
                                                                plugins: { 
                                                                    legend: { display: false }, 
                                                                    datalabels: { 
                                                                        display: true, 
                                                                        backgroundColor: darkMode ? 'rgba(30, 41, 59, 0.8)' : 'rgba(255, 255, 255, 0.9)',
                                                                        borderRadius: 4,
                                                                        borderWidth: 1,
                                                                        borderColor: darkMode ? '#475569' : '#e2e8f0',
                                                                        color: darkMode ? '#fff' : '#0f172a',
                                                                        padding: 4,
                                                                        formatter: (v) => v + '%'
                                                                    } 
                                                                }
                                                            }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            <div className={`p-6 rounded-2xl border ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'} mt-6`}>
                                                <h3 className={`text-lg font-bold mb-4 ${darkMode ? 'text-white' : 'text-slate-800'}`}>Agent Performance</h3>
                                                <div className="h-64">
                                                    <ChartComponent 
                                                        type="bar"
                                                        data={{
                                                            labels: Object.keys(stats.agentStats),
                                                            datasets: [{
                                                                label: 'Avg Score',
                                                                data: Object.values(stats.agentStats).map(s => Math.round(s.total / s.count)),
                                                                backgroundColor: Object.values(stats.agentStats).map(s => (s.total/s.count) >= 85 ? '#10b981' : '#f59e0b'),
                                                                borderRadius: 4,
                                                                datalabels: {
                                                                    anchor: 'end',
                                                                    align: 'top',
                                                                    formatter: (v) => v + '%'
                                                                }
                                                            }]
                                                        }}
                                                        options={{ maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { min: 0, max: 100 } } }}
                                                    />
                                                </div>
                                            </div>

                                            {/* RESTORED AGENT TABLE (Step 5) */}
                                            <div className={`rounded-xl border overflow-hidden ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200 shadow-sm'} mt-6`}>
                                                <table className="w-full text-sm text-left">
                                                    <thead className={`text-xs uppercase ${darkMode ? 'bg-slate-800 text-slate-400' : 'bg-slate-50 text-slate-500'}`}>
                                                        <tr>
                                                            <th className="px-6 py-3">Agent</th>
                                                            <th className="px-6 py-3">Audits</th>
                                                            <th className="px-6 py-3">Avg Score</th>
                                                            <th className="px-6 py-3">Criticals</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className={darkMode ? 'text-slate-300' : 'text-slate-700'}>
                                                        {Object.entries(stats.agentStats).map(([agent, data]) => (
                                                            <tr key={agent} className={`border-b ${darkMode ? 'border-slate-800' : 'border-slate-100'}`}>
                                                                <td className="px-6 py-4 font-medium">{agent}</td>
                                                                <td className="px-6 py-4">{data.count}</td>
                                                                <td className="px-6 py-4 font-bold">{(data.total/data.count).toFixed(0)}%</td>
                                                                <td className="px-6 py-4 text-red-500">{data.criticals}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center h-96 opacity-50">
                                            <Icon name="bar-chart-2" size={48} className="mb-4 text-slate-600" />
                                            <p>No analyzed data yet. Click "Auto-Score" in the sidebar.</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {selectedChatId && (
                                <div className={`absolute inset-0 z-50 flex ${darkMode ? 'bg-slate-950' : 'bg-slate-50'}`}>
                                    <div className="flex-1 flex flex-col border-r border-slate-800">
                                        <header className={`h-16 px-6 flex items-center justify-between border-b ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'}`}>
                                            <div className="flex items-center gap-4">
                                                <button onClick={() => setSelectedChatId(null)} className="p-2 hover:bg-slate-700 rounded-lg text-slate-400"><Icon name="arrow-left" /></button>
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>{chats.find(c=>c.id===selectedChatId)?.agent}</h3>
                                                        {qaData[selectedChatId]?.status === 'Reviewed' && <span className="text-[10px] font-bold bg-emerald-500/20 text-emerald-500 px-2 py-0.5 rounded border border-emerald-500/20">VERIFIED</span>}
                                                        {qaData[selectedChatId]?.status === 'AI_PROPOSED' && <span className="text-[10px] font-bold bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/20 animate-pulse">AI PROPOSED</span>}
                                                        
                                                        {chats.find(c=>c.id===selectedChatId)?.flags?.expired && (
                                                            <span className="px-2 py-0.5 bg-red-500/20 text-red-500 text-[10px] font-bold uppercase rounded border border-red-500/20 flex items-center gap-1">
                                                                <Icon name="clock" size={10}/> EXPIRED
                                                            </span>
                                                        )}
                                                        {chats.find(c=>c.id===selectedChatId)?.flags?.sentimentDrop && (
                                                            <span className="px-2 py-0.5 bg-amber-500/20 text-amber-500 text-[10px] font-bold uppercase rounded border border-amber-500/20 flex items-center gap-1">
                                                                <Icon name="frown" size={10}/> FRICTION
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="text-xs text-slate-500">#{selectedChatId}</p>
                                                </div>
                                            </div>
                                            <div className="flex flex-col items-end">
                                                {(() => {
                                                    const chat = chats.find(c=>c.id===selectedChatId);
                                                    if(!chat?.flowScore) return null;
                                                    return (
                                                        <>
                                                            <div className={`text-lg font-bold flex items-center gap-1 ${chat.flowScore < 70 ? 'text-red-500' : 'text-emerald-500'}`}>
                                                                <Icon name="activity" size={16}/> {chat.flowScore} Flow
                                                            </div>
                                                            <div className="flex gap-1 mt-0.5">
                                                                {chat.flowFlags?.skippedDiscovery && <span className="text-[9px] bg-red-500/20 text-red-400 px-1 rounded uppercase font-bold border border-red-500/30">Skip Discovery</span>}
                                                                {chat.flowFlags?.poorProbing && <span className="text-[9px] bg-amber-500/20 text-amber-400 px-1 rounded uppercase font-bold border border-amber-500/30">Poor Probing</span>}
                                                                {chat.flowFlags?.rushedClosing && <span className="text-[9px] bg-blue-500/20 text-blue-400 px-1 rounded uppercase font-bold border border-blue-500/30">Rushed Close</span>}
                                                                {chat.flowFlags?.escalation && <span className="text-[9px] bg-red-600/30 text-red-200 px-1 rounded uppercase font-bold border border-red-600/50">Escalation</span>}
                                                            </div>
                                                        </>
                                                    );
                                                })()}
                                            </div>
                                        </header>
                                        
                                        <div className={`flex-1 overflow-y-auto p-6 space-y-4 ${darkMode ? 'bg-[#0B1120]' : 'bg-slate-100'}`}>
                                            {/* AI Summary Section */}
                                            {qaData[selectedChatId]?.summary && (
                                                <div className="mb-4 bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl">
                                                    <div className="flex items-center gap-2 mb-2 text-indigo-400 font-bold text-sm">
                                                        <Icon name="bot" size={16}/> AI Analysis
                                                    </div>
                                                    <p className="text-sm text-slate-300 italic mb-2">"{qaData[selectedChatId].summary}"</p>
                                                    {qaData[selectedChatId].coaching && (
                                                        <div className="mt-2 text-xs bg-indigo-500/10 p-2 rounded text-indigo-300 border border-indigo-500/20">
                                                            <strong>💡 Coaching Tip:</strong> {qaData[selectedChatId].coaching}
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {surveys[selectedChatId] && (
                                                <div className="mb-6 rounded-xl border border-purple-500/30 bg-purple-900/10 p-4">
                                                    <h4 className="text-purple-400 font-bold text-sm mb-3 flex items-center gap-2">
                                                        <Icon name="star" size={14} /> Survey Feedback
                                                    </h4>
                                                    <div className="space-y-3">
                                                        {surveys[selectedChatId].map((q, idx) => (
                                                            <div key={idx} className="bg-slate-900/50 p-3 rounded-lg border border-purple-500/10">
                                                                <p className="text-xs text-slate-400 font-medium mb-1">{q.question}</p>
                                                                <div className="flex justify-between items-center">
                                                                    <p className="text-sm text-slate-200 italic">"{q.answer}"</p>
                                                                    <span className="text-xs font-bold bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded">Score: {q.score}</span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {chats.find(c=>c.id===selectedChatId)?.messages.map((msg, i) => (
                                                <div key={i} className={`flex ${msg.type === 'agent' ? 'justify-end' : msg.type === 'system' ? 'justify-center' : 'justify-start'}`}>
                                                    {msg.type === 'system' ? (
                                                        <span className="text-[10px] bg-slate-800 text-slate-500 px-2 py-1 rounded-full uppercase tracking-wider">{msg.text}</span>
                                                    ) : (
                                                        <div className={`max-w-[80%] rounded-2xl p-4 text-sm ${
                                                            msg.type === 'agent' ? 'bg-lenovo-red text-white rounded-br-none shadow-lg shadow-red-900/20' : 
                                                            darkMode ? 'bg-slate-800 text-slate-200 rounded-bl-none' : 'bg-white text-slate-800 rounded-bl-none shadow-sm'
                                                        }`}>
                                                            <div className="mb-1 text-[10px] opacity-50 uppercase font-bold flex justify-between gap-4">
                                                                <span>{msg.sender}</span>
                                                                <div className="flex gap-2">
                                                                    {msg.phase && <span className="opacity-70">{msg.phase}</span>}
                                                                    {msg.intent && <span className="opacity-50">• {msg.intent}</span>}
                                                                    <span>{formatTime(msg.time)}</span>
                                                                </div>
                                                            </div>
                                                            <HighlightedText text={msg.text} />
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className={`w-[450px] overflow-y-auto ${darkMode ? 'bg-slate-900' : 'bg-white'} border-l ${darkMode ? 'border-slate-800' : 'border-slate-200'} flex flex-col`}>
                                        <div className="p-6 flex-1">
                                            <div className="flex justify-between items-center mb-6">
                                                <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'}`}>Scorecard</h3>
                                                <div className={`text-3xl font-black ${
                                                    (qaData[selectedChatId]?.criticalFail && qaData[selectedChatId]?.criticalFail !== "None") ? 'text-red-500' : 
                                                    (qaData[selectedChatId]?.score || 0) >= 85 ? 'text-emerald-500' : 'text-amber-500'
                                                }`}>
                                                    {qaData[selectedChatId]?.score || 0}%
                                                </div>
                                            </div>

                                            <div className={`mb-6 p-4 rounded-xl border ${qaData[selectedChatId]?.criticalFail && qaData[selectedChatId]?.criticalFail !== "None" ? 'bg-red-500/10 border-red-500/30' : 'bg-slate-800/50 border-slate-700'}`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <label className="text-xs uppercase font-bold text-slate-500 block">Critical Failure Mode</label>
                                                    <button onClick={() => setShowCritInfo(true)} className="text-blue-400 hover:text-white p-1"><Icon name="info" size={14}/></button>
                                                </div>
                                                <select 
                                                    className="w-full bg-slate-900 border border-slate-700 text-slate-200 text-sm rounded-lg p-2 focus:ring-1 focus:ring-lenovo-red"
                                                    value={qaData[selectedChatId]?.criticalFail || "None"}
                                                    onChange={(e) => updateCritical(selectedChatId, e.target.value)}
                                                >
                                                    {CRITICAL_TYPES.map(type => <option key={type} value={type}>{type}</option>)}
                                                </select>
                                                {qaData[selectedChatId]?.criticalReason && (
                                                    <div className="mt-2 p-2 bg-red-500/20 text-red-200 text-xs rounded border border-red-500/30">
                                                        <strong>Why?</strong> {qaData[selectedChatId].criticalReason}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="space-y-6 pb-20">
                                                {Object.entries(SCORECARD).map(([cat, items]) => (
                                                    <div key={cat}>
                                                        <h4 className="text-xs font-bold uppercase text-slate-500 mb-3 border-b border-slate-800 pb-1">{cat}</h4>
                                                        <div className="space-y-3">
                                                            {items.map(item => {
                                                                const val = qaData[selectedChatId]?.criteria[item.id] || 'N/A';
                                                                const aiReason = qaData[selectedChatId]?.aiReasoning?.[item.id];
                                                                
                                                                return (
                                                                    <div key={item.id} className={`p-3 rounded-lg border flex flex-col gap-3 ${darkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                                                        <div className="flex justify-between">
                                                                            <div>
                                                                                <div className={`text-sm font-medium ${darkMode ? 'text-slate-300' : 'text-slate-700'}`}>{item.text}</div>
                                                                                <div className="text-[10px] text-slate-500">{item.weight}%</div>
                                                                            </div>
                                                                        </div>
                                                                        <div className="flex gap-1">
                                                                            {['Yes', 'No', 'N/A'].map(opt => (
                                                                                <button
                                                                                    key={opt}
                                                                                    onClick={() => updateCriterion(selectedChatId, item.id, opt)}
                                                                                    className={`flex-1 py-1 text-[10px] font-bold rounded transition-colors ${
                                                                                        val === opt 
                                                                                            ? (opt === 'Yes' ? 'bg-emerald-500 text-white' : opt === 'No' ? 'bg-red-500 text-white' : 'bg-slate-600 text-white')
                                                                                            : 'bg-slate-700/50 text-slate-400 hover:bg-slate-700'
                                                                                    }`}
                                                                                >
                                                                                    {opt}
                                                                                </button>
                                                                            ))}
                                                                        </div>
                                                                        {/* AI Reasoning Tooltip/Text */}
                                                                        {aiReason && qaData[selectedChatId]?.status === 'AI_PROPOSED' && (
                                                                            <div className="text-[10px] text-indigo-300 bg-indigo-500/10 p-1.5 rounded border border-indigo-500/20 italic">
                                                                                🤖 {aiReason}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className={`p-4 border-t ${darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200'} sticky bottom-0 z-10 flex gap-2`}>
                                            <button 
                                                onClick={() => handleAutoScore(selectedChatId)}
                                                disabled={isAIProcessing}
                                                className={`flex-[2] py-3 rounded-lg text-sm font-bold shadow-lg flex items-center justify-center gap-2 transition-all ${
                                                    apiKey 
                                                    ? 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-indigo-900/20' 
                                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                }`}
                                            >
                                                {isAIProcessing ? (
                                                    <>
                                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        Analyzing...
                                                    </>
                                                ) : (
                                                    <>
                                                        <Icon name={apiKey ? "sparkles" : "key"} size={16} /> 
                                                        {apiKey ? "Auto-Score with AI" : "Enter API Key"}
                                                    </>
                                                )}
                                            </button>
                                            <button 
                                                onClick={() => saveReview(selectedChatId)}
                                                className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-emerald-900/20 flex items-center justify-center gap-2"
                                            >
                                                <Icon name="check" size={16} /> Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
